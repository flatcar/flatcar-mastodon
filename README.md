# flatcar-mastodon
Automation for deploying a Mastodon node on Flatcar.

The files and config snippets in this repository allow to fully auto-provision a Mastodon node on Flatcar Container Linux.
Set-up and configuration is automated via Ignition.
Only instance-specific parameters need to be provided.

## Features
- Fully automated deployment based on very few settings (see HowTo below).
- Automated HTTPS certificate retrieval and installation (via caddy + letsencrypt).
- Includes elasticsearch for full-text indexing.

### Planned features
- Simple backup + restore.

## HowTo

Prerequisites: a domain name for your new Mastodon instance, and access to your domain registrar's DNS (see step 7.).

1. Clone this repo.
2. Edit [`caddy/Caddyfile`](caddy/Caddyfile) and set the domain name of your future instance, and the webmaster email address.
3. Edit [`mastodon/admin.env`](mastodon/admin.env) and set the user name and email for Mastodon's initial Administrator account.
   **DO NOT USE 'admin'**. This is a reserved name (Mastodon internal), using 'admin' will cause the initial set-up to fail.
4. Edit [`mastodon/mastodon.env.template`](mastodon/mastodon.env.template) and set your future instance's domain (same as for Caddy above)
   as well as an SMTP account for the instance to send notification emails to all users from.
   Make sure the SMTP configuration is correct as this is the only way of using the initial admin account without manually logging
   into the instance to retrieve the password.
5. Generate Ignition deployment configuration based on your setting by running
   ```shell
   cat mastodon.yaml | docker run --rm -i -v $(pwd):/files ghcr.io/flatcar/ct:latest --files-dir /files > ignition.json
   ```
6. Kick off a [Flatcar installation](https://www.flatcar.org/docs/latest/installing/)
   on [your server](https://www.flatcar.org/docs/latest/installing/bare-metal/),
   on your [favourite public or private cloud](https://www.flatcar.org/docs/latest/installing/cloud/),
   on [your custom virtualisation](https://www.flatcar.org/docs/latest/installing/vms/),
   or on one of the [community contributed platforms](https://www.flatcar.org/docs/latest/installing/community-platforms/).
   Supply the `ignition.json` provisioning config generated above to the deployment (as user data, custom data etc. - it's provider specific).
7. As soon as the provisioning started, update your domain in your registrar's DNS to point to the IP of the new instance.
   This will allow caddy to retrieve a letsencrypt HTTPS certificate during provisioning.
8. Wait for the deployment to conclude.
   You should receive a welcome email from your new Mastodon instance in the administrator account's inbox (see step #3 above).
   The email should arrive at about the time everything is set up, so you can access your instance right away!
   Log in with the admin account's email address and use Mastodon's "reset password" feature to set a new password.
   Alternatively, SSH into the instance and check `/opt/mastodon/admin.env` for the password auto-generated by Mastodon during provisioning.

## Backup and restore
TBD.

General idea is to dump the postgres DB using `pg_dump` and to compress the contents of `elasticsearch/` and `public/` as well as `mastodon.env` into a tarball.
Ideally both SQL and tarball are accessible via (strong password protected) https / CGI.
This would allow for a second node to be deployed, pull that data, and set itself up - fully automated, enabling up- and downscaling of an instance.

## Services structure and dependencies

All services start automatically at boot.

All mastodon services are grouped in an umbrella service and can be started with `systemctl start mastodon` and torn down with `systemctl stop mastodon` respectively.


Services dependent on other services are displayed towards the root; services w/o dependencies are leaves.

```
mastodon.service                              - Umbrella service that depends on all services.
│                                               All dependent services will also be torn down when "mastodon.service" is stopped.
├── mastodon-sidekiq.service                  - Background processing, uses internal + external networking and DBs.
│   ├── mastodon-net-external.service         - Docker user-defined network for external networking.
│   └── mastodon-setup.service                - First-time setup. NOP after installation; useful for maintenance.
│       │                                       Runs with internal network only, needs all DBs.
│       ├── mastodon-db.service               - Postgres, reachable via internal network only.
│       ├── mastodon-es.service               - Elasticsearch, reachable via internal network only.
│       └── mastodon-redis.service            - Redis, reachable via internal network only.
│           └── mastodon-net-internal.service - User-defined container network for internal networking. No I/O to the outside.
├── mastodon-streaming.service                - Streaming API, uses internal + external networking and DBs, listens to 127.0.0.1:5051.
│   ├── mastodon-net-external.service
│   └── mastodon-setup.service
│       ├── mastodon-db.service
│       ├── mastodon-es.service
│       └── mastodon-redis.service
│           └── mastodon-net-internal.service
└── mastodon-web.service                      - Website, uses internal + external networking and DBs, listens to 127.0.0.1:5050.
    ├── mastodon-net-external.service
    └── mastodon-setup.service
        ├── mastodon-db.service
        ├── mastodon-es.service
        └── mastodon-redis.service
            └── mastodon-net-internal.service

caddy.service                                 - Web server proxy and HTTPS termination. Takes care of certs, too.
│                                               Proxies on external network to mastodon-web (127.0.0.1:5050)
│                                                and mastodon-streaming (127.0.0.1:5051).
└── mastodon-net-external.service             - Docker user-defined network for external networking.
```

### Start-up procedure

1. External and internal container networks are started first.
2. Databases (postgres, redis, and elasticsearch) are started as soon as the internal network is up.
3. The initial set-up script runs.
   This is a NOP for subsequent starts after installation.
   However, this stage is also useful for maintenance (see below).
4. Higher level services are starting: web, sidekiq, and streaming.

### Maintenance

The `mastodon-setup` start-up phase (step 2 above) is also useful for maintenance and debugging.
At this stage, only low-level components are up - allowing to start a maintenance environment like e.g.
```shell
systemctl stop mastodon
systemctl start mastodon-setup
source /opt/mastodon/versions.env
docker run -it --rm --network=mastodon-net-internal --env-file="./mastodon.env" -e RAILS_ENV=production ${MASTODON_IMAGE} bash
```
and interacting with the mastodon installation via `bin/tootctl`.

### Update container image versions

Edit `/opt/mastodon/versions.env` and update the version tags.
For minor / patch updates that do not require database migration, simply run `systemctl restart mastodon`.
If DB migration and/or other manual upgrade steps are needed, enter maintenance mode (see above) and perform the required steps.

Common migration steps include .e.g
- migrate the database
  ```
  bundle exec rake mastodon:setup
  ```
- recompile assets
  ```
  bundle exec rails assets:precompile
  ```
- re-generate feeds
  ```
  bundle exec bin/tootctl feeds build
  ```
- re-generate full-text search index
  ```
  bundle exec bin/tootctl search deploy
  ```
